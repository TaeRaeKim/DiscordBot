const { SlashCommandBuilder, EmbedBuilder, PermissionFlagsBits } = require('discord.js');
const config = require('../../config.json');
const googleSheets = require('../utils/googleSheets');

module.exports = {
    data: new SlashCommandBuilder()
        .setName('ì‹œíŠ¸ì •ë¦¬')
        .setDescription('êµ¬ê¸€ ì‹œíŠ¸ì˜ ë¹ˆ í–‰ì„ ì œê±°í•©ë‹ˆë‹¤')
        .setDefaultMemberPermissions(PermissionFlagsBits.ManageGuild),

    disabled: true,

    async execute(interaction) {
        await interaction.reply({
            content: 'âŒ ì´ ëª…ë ¹ì–´ëŠ” í˜„ì¬ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.',
            ephemeral: true
        });
        return;
        await interaction.deferReply({ ephemeral: true });

        try {
            if (!config.googleSheetId || !config.googleSheetGid) {
                return await interaction.editReply({
                    content: 'âŒ êµ¬ê¸€ ì‹œíŠ¸ ì„¤ì •ì´ config.jsonì— ì—†ìŠµë‹ˆë‹¤.\n`googleSheetId`ì™€ `googleSheetGid`ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.',
                    ephemeral: true
                });
            }

            const beforeCount = await googleSheets.getMemberNicknames(
                config.googleSheetId,
                config.googleSheetGid,
                config.nicknameColumn || 'A',
                config.startRow || 1
            );

            const result = await googleSheets.removeEmptyRows(
                config.googleSheetId,
                config.googleSheetGid,
                config.nicknameColumn || 'A',
                config.startRow || 1
            );

            const embed = new EmbedBuilder()
                .setTitle('ğŸ§¹ êµ¬ê¸€ ì‹œíŠ¸ ì •ë¦¬ ì™„ë£Œ')
                .setColor(result.removed > 0 ? 0x4ECDC4 : 0xFFA726)
                .setTimestamp();

            if (result.removed > 0) {
                embed.setDescription(`âœ… ë¹ˆ í–‰ ${result.removed}ê°œë¥¼ ì„±ê³µì ìœ¼ë¡œ ì œê±°í–ˆìŠµë‹ˆë‹¤.`)
                    .addFields(
                        {
                            name: 'ğŸ“Š ì •ë¦¬ ê²°ê³¼',
                            value: `â€¢ ì œê±°ëœ ë¹ˆ í–‰: ${result.removed}ê°œ\nâ€¢ ë‚¨ì€ ë°ì´í„°: ${result.remaining}ê°œ\nâ€¢ ì „ì²´ í–‰ ìˆ˜: ${result.totalRows}ê°œ`,
                            inline: false
                        }
                    );
            } else {
                embed.setDescription('â„¹ï¸ ì œê±°í•  ë¹ˆ í–‰ì´ ì—†ìŠµë‹ˆë‹¤.')
                    .addFields(
                        {
                            name: 'ğŸ“Š í˜„ì¬ ìƒíƒœ',
                            value: `â€¢ ë°ì´í„° í–‰: ${result.remaining}ê°œ\nâ€¢ ì „ì²´ í–‰ ìˆ˜: ${result.totalRows}ê°œ`,
                            inline: false
                        }
                    );
            }

            embed.addFields({
                name: 'âš™ï¸ ì„¤ì • ì •ë³´',
                value: `â€¢ ëŒ€ìƒ ì—´: ${config.nicknameColumn || 'A'}ì—´\nâ€¢ ì‹œì‘ í–‰: ${config.startRow || 1}í–‰`,
                inline: false
            });

            await interaction.editReply({
                embeds: [embed],
                ephemeral: true
            });

        } catch (error) {
            console.error('[ì‹œíŠ¸ì •ë¦¬] ì˜¤ë¥˜:', error);

            let errorMessage = 'âŒ ì‹œíŠ¸ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';

            if (error.message.includes('credentials.json')) {
                errorMessage = 'âŒ Google ì„œë¹„ìŠ¤ ê³„ì • ì¸ì¦ íŒŒì¼(credentials.json)ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.';
            } else if (error.message.includes('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤')) {
                errorMessage = 'âŒ êµ¬ê¸€ ì‹œíŠ¸ì— ì“°ê¸° ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ì‹œíŠ¸ë¥¼ ì„œë¹„ìŠ¤ ê³„ì •ì— í¸ì§‘ì ê¶Œí•œìœ¼ë¡œ ê³µìœ í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.';
            } else if (error.message.includes('ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤')) {
                errorMessage = 'âŒ ì§€ì •ëœ êµ¬ê¸€ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. IDì™€ GIDë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
            }

            await interaction.editReply({
                content: `${errorMessage}\n\`\`\`${error.message}\`\`\``,
                ephemeral: true
            });
        }
    },
};